<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>GRYPTO</title>
    <link rel="stylesheet" href="css.css">
</head>
<body>

    <div id="chat-widget" class="collapsed">
        <div id="chat-header">
          üß† Grypto AI 
          <button id="toggle-expand" title="Geni≈ület" style="float: right;">&#x2922;</button>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input">
          <textarea id="user-input" placeholder="ƒ∞ndikat√∂r verilerini gir veya soru sor..." rows="2"></textarea>
          <button onclick="sendMessage()">Analiz</button>
        </div>
      </div>
      
      <!-- Chat Widget + News JavaScript -->
      <script>
        // Toggle chat widget b√ºy√ºtme/k√º√ß√ºltme
        document.getElementById('toggle-expand').addEventListener('click', function() {
          var widget = document.getElementById('chat-widget');
          widget.classList.toggle('expanded');
          widget.classList.toggle('collapsed');
          if(widget.classList.contains('expanded')) {
            this.innerHTML = "&#x2923;";
          } else {
            this.innerHTML = "&#x2922;";
          }
        });

        function appendMessage(roleLabel, text) {
          const chatMessages = document.getElementById('chat-messages');
          if (!chatMessages) return;

          const msg = document.createElement('div');
          msg.className = 'message';

          const strong = document.createElement('strong');
          strong.textContent = roleLabel + ": ";

          const span = document.createElement('span');
          span.textContent = String(text ?? "");

          msg.appendChild(strong);
          msg.appendChild(span);
          chatMessages.appendChild(msg);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function renderBotStructured(data) {
          if (data && typeof data === "object" && ("direction" in data)) {
            const parts = [
              `Direction: ${data.direction ?? "HOLD"}`,
              `Confidence: ${data.confidence ?? 0}%`,
              `Entry: ${data.entry ?? "N/A"}`,
              `TP: ${data.tp ?? "N/A"}`,
              `SL: ${data.sl ?? "N/A"}`,
              `RR: ${data.rr ?? "0"}`
            ];
            const why = Array.isArray(data.why) ? data.why.join(" | ") : "";
            return parts.join(" | ") + (why ? `\nWhy: ${why}` : "");
          }
          if (data && typeof data.response === "string") return data.response;
          try {
            return JSON.stringify(data);
          } catch(e) {
            return String(data);
          }
        }

        async function sendMessage() {
          const input = document.getElementById('user-input');
          const message = (input && input.value ? input.value : "").trim();
          if (!message) return;
          if (input) input.value = "";

          appendMessage("Siz", message);

          try {
            const response = await fetch('/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ input: message })
            });
            const data = await response.json();
            appendMessage("GryptoAI", renderBotStructured(data));
          } catch (err) {
            appendMessage("System", "Request failed: " + (err && err.message ? err.message : String(err)));
          }
        }

        // Button onclick="sendMessage()" √ßalƒ±≈üsƒ±n diye global
        window.sendMessage = sendMessage;

        // Enter ile g√∂nder
        document.getElementById('user-input').addEventListener('keydown', function(e) {
          if(e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        // ====== ORƒ∞Jƒ∞NAL NEWS BLOƒûUN (AYNEN KORUNDU) ======
        const API_KEY = 'jjislkhw1wz9tldkkahbmyodidc2bgab5eezvrzn';

async function fetchNews(tag, containerId) {
    try {
        const apiUrl = `https://api.rss2json.com/v1/api.json?api_key=${API_KEY}&rss_url=https://cointelegraph.com/rss/tag/${tag}`;
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`HTTP hatasƒ±: ${response.status}`);
        
        const data = await response.json();
        if (data.status !== 'ok') throw new Error(data.message);
        
        const container = document.querySelector(`#${containerId} .news-items`);
        container.innerHTML = data.items.slice(0,5).map(item => `
            <div class="news-item">
                <img src="${item.enclosure?.link || 'https://i.ibb.co/0j7JQYV/placeholder-news.png'}" 
                     class="news-image"
                     onerror="this.src='https://i.ibb.co/0j7JQYV/placeholder-news.png'">
                <div class="news-content">
                    <h3>${item.title}</h3>
                    <p>${item.description.replace(/<[^>]*>/g, '').substring(0, 100)}...</p>
                    <a href="${item.link}" target="_blank">Devamƒ±nƒ± oku ‚Üí</a>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Haber √ßekme hatasƒ±:', error);
        const container = document.querySelector(`#${containerId} .news-items`);
        container.innerHTML = `<div class="error">‚ö†Ô∏è Haberler y√ºklenemedi: ${error.message}</div>`;
    }
}

window.onload = () => {
    fetchNews('bitcoin', 'bitcoin-news');
    fetchNews('ethereum', 'ethereum-news');
    setInterval(() => {
        fetchNews('bitcoin', 'bitcoin-news');
        fetchNews('ethereum', 'ethereum-news');
    }, 300000); // 5 dakikada bir g√ºncelle
};
      </script>
</body>

</html>
